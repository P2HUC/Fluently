<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Check Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .editor-container {
            flex: 3;
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: white;
            border-right: 1px solid #ccc;
        }

        #text-editor {
            flex: 1;
            padding: 20px;
            font-size: 16px;
            line-height: 1.6;
            border: none;
            outline: none;
            white-space: pre-wrap;
            overflow-y: auto;
            background-color: #fff;
        }

        .corrections-panel {
            flex: 1;
            padding: 10px;
            background-color: #f0f0f5;
            width: 300px;
            overflow-y: auto;
            position: relative;
        }

        .corrections-panel h2 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .correction-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .correction-item .suggestion {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
            margin-top: 10px;
        }

        .highlight-red {
            background-color: #fdd;
            text-decoration: underline red wavy;
        }

        .highlight-yellow {
            background-color: #ffeb99;
            text-decoration: underline yellow wavy;
        }

        .highlight-blue {
            background-color: #d0e6f8;
            text-decoration: underline blue wavy;
        }

        .error-counter {
            font-weight: bold;
            margin-left: 5px;
        }

        /* Added buttons */
        .buttons {
            display: flex;
            justify-content: flex-end;
            padding: 10px;
            background-color: #f5f5f5;
            border-top: 1px solid #ccc;
        }

        .buttons button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            margin-left: 10px;
        }

        .buttons button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="editor-container">
            <div id="text-editor" contenteditable="true">
            </div>

            <!-- Buttons for "Copy", "Delete", "Home", and "Correct All" -->
            <div class="buttons">
                <button id="home-btn">Home</button>
                <button id="correct-all-btn">Correct All</button>
                <button id="copy-btn">Copy</button>
                <button id="delete-btn">Delete</button>
            </div>
        </div>
        <div class="corrections-panel">
            <h2>Correct <span class="error-counter" id="error-counter">0</span></h2>
            <div id="correction-list">
                <!-- Error corrections will be dynamically added here -->
            </div>
        </div>
    </div>

    <script>
        const editor = document.getElementById('text-editor');
        const correctionList = document.getElementById('correction-list');
        const errorCounter = document.getElementById('error-counter');
        const copyBtn = document.getElementById('copy-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const homeBtn = document.getElementById('home-btn');
        const correctAllBtn = document.getElementById('correct-all-btn');

        let typingTimer;
        let errors = [];
        let lastText = '';

        async function checkGrammar(text) {
            try {
                const response = await fetch('https://api.languagetool.org/v2/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'text': text,
                        'language': 'en-US'
                    })
                });

                const data = await response.json();
                errors = data.matches;
                highlightErrors(errors);
                updateCorrectionsPanel(errors);

            } catch (error) {
                console.error('Error checking grammar:', error);
            }
        }

        function highlightErrors(matches) {
            const content = editor.innerText;
            let updatedContent = content;
            let offset = 0;

            matches.forEach(match => {
                const incorrectText = updatedContent.substring(match.offset + offset, match.offset + offset + match.length);
                let className = '';

                if (match.rule.issueType === 'misspelling') {
                    className = 'highlight-red';
                } else if (match.rule.issueType === 'grammar') {
                    className = 'highlight-yellow';
                } else {
                    className = 'highlight-blue';
                }

                const span = `<span class="${className}" data-error="${match.message}" data-suggestions="${match.replacements.map(r => r.value).join(',')}">${incorrectText}</span>`;
                updatedContent = updatedContent.substring(0, match.offset + offset) + span + updatedContent.substring(match.offset + offset + match.length);
                offset += span.length - match.length;
            });

            editor.innerHTML = updatedContent;
        }

        function updateCorrectionsPanel(matches) {
            correctionList.innerHTML = '';
            matches.forEach((match, index) => {
                const listItem = document.createElement('div');
                listItem.classList.add('correction-item');
                listItem.id = `correction-${index}`; // Add ID to make it removable later
                listItem.innerHTML = `
                    <span>${match.rule.issueType} - ${match.message}</span>
                    <div class="suggestion" onclick="replaceText('${match.replacements[0]?.value}', ${match.offset}, ${match.length}, ${index})">
                        ${match.replacements[0]?.value}
                    </div>
                `;
                correctionList.appendChild(listItem);
            });

            errorCounter.textContent = matches.length;
        }

        function replaceText(suggestion, offset, length, correctionIndex) {
            const content = editor.innerText;

            // Replace the error with the suggestion
            const updatedText = content.substring(0, offset) + suggestion + content.substring(offset + length);
            editor.innerText = updatedText;

            // Re-check grammar for remaining errors after correction
            setTimeout(() => checkGrammar(updatedText), 100);

            // Remove the corrected issue from the panel
            const correctionItem = document.getElementById(`correction-${correctionIndex}`);
            if (correctionItem) {
                correctionItem.remove();
            }

            // Update the error count
            const currentErrors = correctionList.querySelectorAll('.correction-item').length;
            errorCounter.textContent = currentErrors;
        }

        // Function to replace text with adjusted offsets for "Correct All"
        function replaceTextAdjusted(suggestion, offset, length) {
            const content = editor.innerText;

            // Replace the error with the suggestion
            const updatedText = content.substring(0, offset) + suggestion + content.substring(offset + length);

            // Set the updated text in the editor
            editor.innerText = updatedText;
            
            return updatedText; // Return updated text to recalculate the offsets
        }

        // Apply all corrections at once
        correctAllBtn.addEventListener('click', () => {
            let content = editor.innerText; // Get the current text in the editor
            let totalOffsetChange = 0; // Track the total offset adjustment

            errors.forEach((error, index) => {
                const suggestion = error.replacements[0]?.value;
                if (suggestion) {
                    // Calculate the corrected offset by adding the totalOffsetChange
                    const correctedOffset = error.offset + totalOffsetChange;
                    
                    // Replace the text at the adjusted offset
                    content = replaceTextAdjusted(suggestion, correctedOffset, error.length);
                    
                    // Adjust the total offset change based on the difference between the original and replacement text lengths
                    totalOffsetChange += suggestion.length - error.length;
                }

                // Remove the correction item from the panel
                const correctionItem = document.getElementById(`correction-${index}`);
                if (correctionItem) {
                    correctionItem.remove();
                }
            });

            // Re-check grammar for remaining errors after correction
            setTimeout(() => checkGrammar(content), 100);

            // Update the error counter after correction
            errorCounter.textContent = '0'; // Assuming all errors were fixed
        });

        function delayedGrammarCheck() {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                const currentText = editor.innerText;
                if (currentText !== lastText) {
                    checkGrammar(currentText);
                    lastText = currentText;
                }
            }, 1000);
        }

        // Copy functionality
        copyBtn.addEventListener('click', () => {
            const range = document.createRange();
            range.selectNodeContents(editor);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('copy');
        });

        // Delete functionality
        deleteBtn.addEventListener('click', () => {
            editor.innerText = '';  // Clear the editor
            correctionList.innerHTML = '';  // Clear the correction panel
            errorCounter.textContent = '0';  // Reset the error counter
        });

        // Go back to index.html
        homeBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        editor.addEventListener('input', delayedGrammarCheck);
    </script>

</body>
</html>
